{% extends "layouts/base.html" %}

{% block title %}Pengaturan Kamera - Penghitung Orang CCTV{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/door-config.js') }}"></script>
<style>
    #door-status {
        min-height: 24px;
        font-weight: 500;
    }

    #selection-box {
        position: absolute;
        border: 3px dashed var(--primary-color);
        background: rgba(79, 70, 229, 0.1);
        pointer-events: none;
        z-index: 100;
        border-radius: var(--radius-sm);
    }

    #video-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: var(--radius-lg);
        background: linear-gradient(45deg, var(--bg-tertiary), var(--bg-secondary));
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: var(--spacing-sm);
    }

    .status-indicator.success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-indicator.error {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        color: var(--danger-color);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast {
        padding: 12px 16px;
        border-radius: var(--radius-md);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        max-width: 400px;
        transform: translateX(120%);
        transition: transform 0.3s ease;
        animation: slide-in 0.3s forwards, fade-out 0.3s 3.7s forwards;
    }

    .toast.success {
        background: linear-gradient(135deg, #10b981, #065f46);
        color: white;
    }

    .toast.error {
        background: linear-gradient(135deg, #ef4444, #991b1b);
        color: white;
    }

    .toast.warning {
        background: linear-gradient(135deg, #f59e0b, #b45309);
        color: white;
    }

    .toast.info {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
    }

    .toast-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toast-icon {
        font-size: 20px;
    }

    .toast-message {
        font-weight: 500;
    }

    .toast-close {
        background: transparent;
        border: none;
        color: white;
        opacity: 0.7;
        cursor: pointer;
        font-size: 18px;
    }

    .toast-close:hover {
        opacity: 1;
    }

    @keyframes slide-in {
        from { transform: translateX(120%); }
        to { transform: translateX(0); }
    }

    @keyframes fade-out {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        background: var(--bg-primary);
        margin: 10% auto;
        padding: 24px;
        max-width: 500px;
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        animation: modal-in 0.3s forwards;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }    @keyframes modal-in {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .alert.alert-success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: var(--radius-md);
        padding: 12px 16px;
    }
    
    .info-box {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04));
        border: 1px solid rgba(59, 130, 246, 0.15);
        border-radius: var(--radius-md);
        margin-bottom: 16px;
    }
    
    .info-icon {
        font-size: 1.5rem;
        line-height: 1;
    }
    
    .info-content {
        flex: 1;
    }
    
    .info-content h5 {
        margin: 0 0 8px 0;
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .info-content p {
        margin: 0 0 8px 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .info-content ul {
        margin: 0 0 8px 0;
        padding-left: 20px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .info-content li {
        margin-bottom: 4px;
    }
    
    #door-success-details {
        background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    #door-success-details:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .success-highlight {
        color: var(--success-color);
        font-weight: 600;
    }
    
    /* Info alert box */
    .info-alert {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 20px;
        color: var(--text-primary);
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .info-alert-icon {
        font-size: 20px;
        color: #3b82f6;
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .info-alert-content {
        flex: 1;
    }
    
    .info-alert-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #3b82f6;
    }
    
    .info-alert-message {
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="page-header">
        <h1>Pengaturan Kamera</h1>
        <p>Konfigurasi sistem pemantauan dan deteksi</p>
    </div>    
    
    <!-- Information notification -->
    <div class="info-alert" id="settings-notification">
        <div class="info-alert-icon">‚ÑπÔ∏è</div>
        <div class="info-alert-content">
            <div class="info-alert-title">Informasi Pengaturan Kamera</div>
            <div class="info-alert-message">
                <p>Pengaturan kamera yang tepat akan memastikan kinerja optimal sistem penghitung orang. Pastikan:</p>
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li>Kamera dipasang pada sudut yang tepat untuk memantau pintu masuk/keluar</li>
                    <li>Resolusi video diatur sesuai kemampuan sistem anda</li>
                    <li>Area pintu dikonfigurasi dengan benar dengan menandai pintu pada video</li>
                </ul>
            </div>
        </div>
        <button class="toast-close" onclick="document.getElementById('settings-notification').style.display='none'">&times;</button>
    </div>
    
    <div class="form-section">
        <h3>‚ö° Mode Pemrosesan</h3>
        <div class="processing-section">
            <div class="input-group">
                <label for="processing-mode">Pilih mode pemrosesan:</label>
                <select id="processing-mode" style="width: 100%;">
                    <option value="gpu" {% if settings.use_gpu !=False %}selected{% endif %}>üöÄ GPU (CUDA) - Lebih Cepat</option>
                    <option value="cpu" {% if settings.use_gpu==False %}selected{% endif %}>üíª CPU - Kompatibel</option>
                </select>
            </div>

            <div id="processing-status">
                {% if not cuda_available %}
                <div class="alert alert-warning" style="margin: var(--spacing-md) 0;">
                    <p><strong>CUDA tidak tersedia di sistem ini.</strong> Akselerasi GPU tidak akan berfungsi.</p>
                </div>
                {% endif %}
            </div>

            <div class="button-group">
                <button id="toggle-processing" type="button" class="btn btn-secondary">
                    <span>‚ö°</span> Terapkan Mode Pemrosesan
                </button>
            </div>
        </div>
    </div>

    <form action="{{ url_for('main.camera_settings') }}" method="POST" class="camera-form">
        <div class="form-section">
            <h3>üé• Pengaturan Sumber Video</h3>
            <div class="input-group">
                <label for="video-source">Sumber Video</label>
                <select id="video-source" name="video_source" onchange="toggleCameraFields(this.value)">
                    <option value="camera" {% if settings.video_source !='demo' %}selected{% endif %}>üìπ Kamera</option>
                    <option value="demo" {% if settings.video_source=='demo' %}selected{% endif %}>üé¨ Video Demo (untuk
                        testing)</option>
                </select>
            </div>

            <div id="camera-fields" {% if settings.video_source=='demo' %}style="display:none" {% endif %}>
                <div class="input-group">
                    <label for="camera-url">URL Stream Kamera</label>
                    <input type="text" id="camera-url" name="camera_url"
                        value="{{ settings.camera_url if settings else '0' }}"
                        placeholder="0 untuk kamera default, atau URL RTSP">
                </div>

                <div class="input-group">
                    <label for="frame-rate">Frame Rate</label>
                    <input type="number" id="frame-rate" name="frame_rate"
                        value="{{ settings.frame_rate if settings else 30 }}" min="1" max="60">
                </div>                <div class="input-group">
                    <label for="resolution">Resolusi (format: width,height)</label>
                    <input type="text" id="resolution" name="resolution"
                        value="{{ settings.resolution if settings else '640,480' }}" placeholder="640,480">
                </div>
                
                <!-- Camera Setup Information -->
                <div class="info-section" style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.02)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--primary-color); font-size: 14px; font-weight: 600;">
                        üìπ Panduan Pengaturan Kamera
                    </h4>
                    
                    <div style="margin-bottom: 12px;">
                        <strong style="color: var(--text-primary); font-size: 13px;">üîå Kamera Default (Webcam):</strong>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">
                            Gunakan <code style="background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px;">0</code> untuk webcam bawaan atau 
                            <code style="background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px;">1</code>, 
                            <code style="background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px;">2</code> untuk kamera USB tambahan
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong style="color: var(--text-primary); font-size: 13px;">üì° RTSP Stream:</strong>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">
                            Format: <code style="background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px;">rtsp://username:password@ip:port/path</code>
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: var(--text-primary); font-size: 13px;">üìù Contoh RTSP URL:</strong>
                        <ul style="margin: 4px 0 0 16px; padding: 0; font-size: 11px; color: var(--text-secondary);">
                            <li style="margin-bottom: 2px;">Hikvision: <code style="background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 2px;">rtsp://admin:pass@192.168.1.100:554/Streaming/Channels/101</code></li>
                            <li style="margin-bottom: 2px;">Dahua: <code style="background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 2px;">rtsp://admin:pass@192.168.1.100:554/cam/realmonitor?channel=1</code></li>
                            <li style="margin-bottom: 2px;">Generic: <code style="background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 2px;">rtsp://admin:pass@192.168.1.100:554/stream1</code></li>
                        </ul>
                    </div>
                    
                    <div style="padding: 8px; background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 6px; margin-top: 8px;">
                        <p style="margin: 0; font-size: 11px; color: rgb(146, 64, 14); line-height: 1.3;">
                            üí° <strong>Tips:</strong> Untuk RTSP, gunakan frame rate 15-30 FPS dan resolusi sesuai kemampuan kamera. 
                            Test URL RTSP di VLC player terlebih dahulu untuk memastikan koneksi berhasil.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn" id="update-camera-settings">üîÑ Perbarui Pengaturan Kamera</button>
            </div>
        </div>
    </form>

    <div class="form-section">
        <h3>üö™ Konfigurasi Area Pintu</h3>        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
            Klik dan seret pada video untuk mendefinisikan area pintu yang akan digunakan untuk deteksi masuk/keluar.
            <br><small style="color: var(--text-muted);">üìπ Video menampilkan sumber asli tanpa deteksi untuk kemudahan konfigurasi area.</small>
        </p>

        <div class="video-container">
            <div id="video-wrapper">
                <img src="{{ url_for('main.raw_video_feed') }}" id="video-feed" alt="Raw Video Feed">
                <div id="selection-box" style="display: none;"></div>
            </div>
        </div>

        <div class="stats-grid" style="margin-top: var(--spacing-lg);">
            <div class="card">
                <h4 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">üìç Koordinat Area</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
                    <div class="input-group">
                        <label for="x1">X1:</label>
                        <input type="number" id="x1" value="{{ door_area.x1 if door_area else '' }}" readonly>
                    </div>
                    <div class="input-group">
                        <label for="y1">Y1:</label>
                        <input type="number" id="y1" value="{{ door_area.y1 if door_area else '' }}" readonly>
                    </div>
                    <div class="input-group">
                        <label for="x2">X2:</label>
                        <input type="number" id="x2" value="{{ door_area.x2 if door_area else '' }}" readonly>
                    </div>
                    <div class="input-group">
                        <label for="y2">Y2:</label>
                        <input type="number" id="y2" value="{{ door_area.y2 if door_area else '' }}" readonly>
                    </div>
                </div>
            </div>            <div class="card">
                <h4 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">üß≠ Pengaturan Arah</h4>
                
                <div id="door-orientation-info" class="info-box">
                    <div class="info-icon">‚ÑπÔ∏è</div>
                    <div class="info-content">
                        <h5>Tips untuk Pintu Vertikal</h5>
                        <p>Untuk pintu vertikal seperti pada gambar, perhatikan:</p>
                        <ul>
                            <li>Pilih "Sisi Kiri" jika dalam ruangan berada di sebelah kiri pintu</li>
                            <li>Pilih "Sisi Kanan" jika dalam ruangan berada di sebelah kanan pintu</li>
                        </ul>
                        <p>Untuk hasil optimal, pastikan area pintu mencakup seluruh frame pintu.</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="inside-direction">Arah Dalam Ruangan:</label>
                    <select id="inside-direction">
                        <option value="right" {% if inside_direction=='right' %}selected{% endif %}>‚û°Ô∏è Sisi Kanan
                        </option>
                        <option value="left" {% if inside_direction=='left' %}selected{% endif %}>‚¨ÖÔ∏è Sisi Kiri</option>
                        <option value="up" {% if inside_direction=='up' %}selected{% endif %}>‚¨ÜÔ∏è Sisi Atas</option>
                        <option value="down" {% if inside_direction=='down' %}selected{% endif %}>‚¨áÔ∏è Sisi Bawah</option>
                    </select>
                </div>

                <div class="button-group">
                    <button id="save-door" type="button" class="btn">üíæ Simpan Area Pintu</button>
                </div>

                <div id="door-status"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Show welcome toast and info modal on page load
    window.addEventListener('DOMContentLoaded', function() {
        // Check if this is the first visit (could use sessionStorage)
        const hasVisitedBefore = sessionStorage.getItem('hasVisitedCameraSettings');
        
        if (!hasVisitedBefore) {
            // Show welcome modal after a short delay
            setTimeout(() => {
                openModal('info-modal');
            }, 800);
            
            // Mark as visited
            sessionStorage.setItem('hasVisitedCameraSettings', 'true');
        }
        
        // Show welcome toast
        setTimeout(() => {
            showToast('Selamat datang di pengaturan kamera!', 'info');
        }, 500);
        
        // Show configuration tip after a delay
        setTimeout(() => {
            showToast('Tip: Gunakan "0" sebagai URL untuk kamera webcam lokal', 'info');
        }, 3000);
        
        // Parse URL for any message parameters
        const urlParams = new URLSearchParams(window.location.search);
        const successMsg = urlParams.get('success');
        const errorMsg = urlParams.get('error');
        
        // Show success or error messages if present in URL
        if (successMsg) {
            showToast('‚úÖ ' + decodeURIComponent(successMsg), 'success');
        }
        
        if (errorMsg) {
            showToast('‚ùå ' + decodeURIComponent(errorMsg), 'error');
        }
    });

    function toggleCameraFields(value) {
        const cameraFields = document.getElementById('camera-fields');
        if (value === 'demo') {
            cameraFields.style.display = 'none';
        } else {
            cameraFields.style.display = 'block';
        }
    }

    // Toggle processing device (GPU/CPU)
    document.getElementById('toggle-processing').addEventListener('click', function () {
        const processingMode = document.getElementById('processing-mode').value;
        const useGpu = processingMode === 'gpu';
        const modeText = useGpu ? 'üöÄ GPU (CUDA)' : 'üíª CPU';
        
        // Update modal text
        document.getElementById('selected-mode-text').textContent = modeText;
        
        // Open confirmation modal
        openModal('processing-modal');
        
        // Setup confirmation button action
        document.getElementById('confirm-processing-change').onclick = function() {
            // Close the modal
            closeModal('processing-modal');
            
            // Show loading toast
            showToast('‚è≥ Mengubah mode pemrosesan...', 'info');
            
            // Send request to toggle processing device
            fetch('/toggle-processing-device', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    use_gpu: useGpu
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`‚úÖ Perangkat pemrosesan diatur ke: ${data.device}`, 'success');
                    
                    if (useGpu && !data.cuda_available) {
                        setTimeout(() => {
                            showToast('‚ö†Ô∏è CUDA tidak tersedia. Menggunakan CPU meskipun dipilih GPU.', 'warning');
                        }, 500);
                    }
                } else {
                    showToast(`‚ùå Error mengatur perangkat pemrosesan: ${data.error || 'Error tidak diketahui'}`, 'error');
                }
            })
            .catch(error => {
                showToast(`‚ùå Error: ${error.message}`, 'error');
            });
        };
    });    // Camera settings form submission
    document.getElementById('update-camera-settings').addEventListener('click', function() {
        // Populate preview data
        const videoSource = document.getElementById('video-source').value;
        const sourceText = videoSource === 'camera' ? 'üìπ Kamera' : 'üé¨ Video Demo';
        document.getElementById('preview-source').textContent = sourceText;
        
        if (videoSource === 'camera') {
            const cameraUrl = document.getElementById('camera-url').value || '0';
            document.getElementById('preview-url').textContent = cameraUrl;
        } else {
            document.getElementById('preview-url').textContent = 'app/static/videos/demo.mp4';
        }
        
        const frameRate = document.getElementById('frame-rate').value || '30';
        document.getElementById('preview-framerate').textContent = frameRate + ' fps';
        
        const resolution = document.getElementById('resolution').value || '640,480';
        document.getElementById('preview-resolution').textContent = resolution.replace(',', ' √ó ');
        
        // Open confirmation modal
        openModal('camera-settings-modal');
        
        // Setup confirmation button action
        document.getElementById('confirm-camera-settings').onclick = function() {
            // Close the modal
            closeModal('camera-settings-modal');
            
            // Show loading toast
            showToast('‚è≥ Menyimpan pengaturan kamera...', 'info');
            
            // Submit the form with error handling
            const form = document.querySelector('.camera-form');
            
            // Use an old-school form submission with target set to a hidden iframe
            // This prevents page reload while still allowing the form to submit
            const formData = new FormData(form);
            
            // Create a hidden form to submit via AJAX
            const hiddenForm = document.createElement('form');
            hiddenForm.method = 'POST';
            hiddenForm.action = form.action;
            hiddenForm.style.display = 'none';
            
            // Copy all form data
            for (const [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                hiddenForm.appendChild(input);
            }
            
            document.body.appendChild(hiddenForm);
            
            // Handle possible errors
            window.addEventListener('error', function(e) {
                // Check if it's likely an OpenCV error
                if (e.message.includes('OpenCV') || e.message.includes('cv2.error')) {
                    handleOpenCVError();
                    return;
                }
                
                showToast('‚ùå Terjadi kesalahan saat menyimpan pengaturan', 'error');
            }, { once: true });
            
            // Submit the form
            try {
                hiddenForm.submit();
                
                // Show success toast after a short delay
                setTimeout(() => {
                    showToast('‚úÖ Pengaturan kamera berhasil disimpan', 'success');
                    
                    // Reload the page after a delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }, 1000);
            } catch (error) {
                // Handle any errors during form submission
                handleError(error);
            }
        };
    });
      // Handle OpenCV errors specifically
    function handleOpenCVError() {
        // Show specific error modal for OpenCV errors
        document.getElementById('error-message').textContent = 
            'Error OpenCV: Tidak dapat mengakses kamera dengan pengaturan ini. Silakan periksa URL dan resolusi kamera.';
        document.getElementById('opencv-help').style.display = 'block';
        openModal('error-modal');
        
        // Also show a toast for immediate feedback
        showToast('‚ùå Error akses kamera. Lihat detail di jendela yang muncul.', 'error');
    }
    
    // Generic error handler
    function handleError(error) {
        const errorMsg = error.message || 'Terjadi kesalahan yang tidak diketahui';
        
        // Check if it might be an OpenCV error
        if (errorMsg.includes('OpenCV') || errorMsg.includes('cv2') || 
            errorMsg.includes('camera') || errorMsg.includes('kamera')) {
            handleOpenCVError();
            return;
        }
        
        // Generic error
        document.getElementById('error-message').textContent = errorMsg;
        document.getElementById('opencv-help').style.display = 'none';
        openModal('error-modal');
        
        showToast('‚ùå Error: ' + errorMsg, 'error');
    }
    
    // Function to save door configuration
    function saveDoorConfig(callback) {
        const x1 = parseInt(document.getElementById('x1').value);
        const y1 = parseInt(document.getElementById('y1').value);
        const x2 = parseInt(document.getElementById('x2').value);
        const y2 = parseInt(document.getElementById('y2').value);
        const insideDirection = document.getElementById('inside-direction').value;

        if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) {
            if (callback) callback(false, 'Silakan gambar area pintu terlebih dahulu');
            return;
        }

        const data = {
            x1, y1, x2, y2,
            inside_direction: insideDirection
        };

        fetch('/api/door-area', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (callback) callback(true, result.message);
            } else {
                if (callback) callback(false, result.message || 'Terjadi kesalahan saat menyimpan area pintu');
            }
        })
        .catch(error => {
            if (callback) callback(false, error.message || 'Terjadi kesalahan saat menghubungi server');
        });
    }
    
    // Door area configuration
    document.getElementById('save-door').addEventListener('click', function() {
        const x1 = document.getElementById('x1').value;
        const y1 = document.getElementById('y1').value;
        const x2 = document.getElementById('x2').value;
        const y2 = document.getElementById('y2').value;
        const direction = document.getElementById('inside-direction').value;
        
        if (!x1 || !y1 || !x2 || !y2) {
            showToast('‚ùå Silakan pilih area pintu terlebih dahulu dengan klik dan seret pada video', 'error');
            return;
        }
        
        // Update modal text
        document.getElementById('modal-x1').textContent = x1;
        document.getElementById('modal-y1').textContent = y1;
        document.getElementById('modal-x2').textContent = x2;
        document.getElementById('modal-y2').textContent = y2;
        
        let directionText = '';
        switch(direction) {
            case 'right': directionText = '‚û°Ô∏è Sisi Kanan'; break;
            case 'left': directionText = '‚¨ÖÔ∏è Sisi Kiri'; break;
            case 'up': directionText = '‚¨ÜÔ∏è Sisi Atas'; break;
            case 'down': directionText = '‚¨áÔ∏è Sisi Bawah'; break;
        }
        document.getElementById('modal-direction').textContent = directionText;
        
        // Open confirmation modal
        openModal('door-config-modal');
        
        // Setup confirmation button action
        document.getElementById('confirm-door-config').onclick = function() {
            // Close the modal
            closeModal('door-config-modal');
            
            // Show loading toast
            showToast('‚è≥ Menyimpan konfigurasi area pintu...', 'info');
              // Use the existing saveDoorConfig function from door-config.js
            saveDoorConfig(function(success, message) {
                if (success) {
                    showToast('‚úÖ ' + message, 'success');
                    
                    // Show success details in a separate modal
                    document.getElementById('success-x1').textContent = x1;
                    document.getElementById('success-y1').textContent = y1;
                    document.getElementById('success-x2').textContent = x2;
                    document.getElementById('success-y2').textContent = y2;
                    document.getElementById('success-direction').textContent = directionText;
                      // Calculate and display door area size
                    const doorWidth = Math.abs(x2 - x1);
                    const doorHeight = Math.abs(y2 - y1);
                    document.getElementById('door-width').textContent = doorWidth;
                    document.getElementById('door-height').textContent = doorHeight;
                    
                    // Open success modal with a slight delay for better user experience
                    setTimeout(() => {
                        openModal('door-success-modal');
                        
                        // Add some animation to the success details
                        const successDetails = document.getElementById('door-success-details');
                        successDetails.style.opacity = '0';
                        successDetails.style.transform = 'translateY(10px)';
                        
                        setTimeout(() => {
                            successDetails.style.transition = 'all 0.5s ease';
                            successDetails.style.opacity = '1';
                            successDetails.style.transform = 'translateY(0)';
                        }, 300);
                    }, 500);
                } else {
                    showToast('‚ùå ' + message, 'error');
                }
            });
        };
    });
    
    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // When clicking outside the modal, close it
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
    
    // Function to show success modal after door area is saved
    function showSuccessDoorModal(data) {
        // Populate the success modal with door configuration data
        document.getElementById('success-x1').textContent = data.x1;
        document.getElementById('success-y1').textContent = data.y1;
        document.getElementById('success-x2').textContent = data.x2;
        document.getElementById('success-y2').textContent = data.y2;
        
        // Calculate door dimensions
        const doorWidth = Math.abs(data.x2 - data.x1);
        const doorHeight = Math.abs(data.y2 - data.y1);
        document.getElementById('door-width').textContent = doorWidth;
        document.getElementById('door-height').textContent = doorHeight;
        
        // Display direction in human-readable form
        let directionText = '';
        switch(data.inside_direction) {
            case 'right': directionText = '‚û°Ô∏è Sisi Kanan'; break;
            case 'left': directionText = '‚¨ÖÔ∏è Sisi Kiri'; break;
            case 'up': directionText = '‚¨ÜÔ∏è Sisi Atas'; break;
            case 'down': directionText = '‚¨áÔ∏è Sisi Bawah'; break;
            default: directionText = data.inside_direction;
        }
        document.getElementById('success-direction').textContent = directionText;
        
        // Show the success modal
        openModal('door-success-modal');
    }
</script>

<!-- Toast notification container -->
<div class="toast-container" id="toast-container"></div>

<!-- Error handling modal -->
<div id="error-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Kesalahan</h3>
            <button class="modal-close" onclick="closeModal('error-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-error" style="margin: 0;">
                <p id="error-message">Terjadi kesalahan.</p>
            </div>
            
            <div id="opencv-help" style="margin-top: 15px; display: none;">
                <h4>Kemungkinan Penyebab:</h4>
                <ul style="padding-left: 20px;">
                    <li>URL kamera tidak valid atau tidak dapat diakses</li>
                    <li>Format resolusi tidak didukung oleh kamera</li>
                    <li>Kamera digunakan oleh aplikasi lain</li>
                    <li>Kamera tidak terhubung dengan benar</li>
                </ul>
                
                <h4 style="margin-top: 15px;">Saran:</h4>
                <ul style="padding-left: 20px;">
                    <li>Jika menggunakan kamera lokal, coba gunakan nilai "0" untuk URL kamera</li>
                    <li>Coba gunakan resolusi yang lebih rendah (mis. 640,480)</li>
                    <li>Periksa koneksi kamera Anda</li>
                    <li>Tutup aplikasi lain yang mungkin menggunakan kamera</li>
                    <li>Gunakan video demo untuk pengujian jika kamera tidak tersedia</li>
                </ul>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('error-modal')">Tutup</button>
        </div>
    </div>
</div>

<!-- Info modal to display on load -->
<div id="info-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Informasi Pengaturan Kamera</h3>
            <button class="modal-close" onclick="closeModal('info-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-alert" style="margin-bottom: 16px;">
                <div class="info-alert-icon">‚ÑπÔ∏è</div>
                <div class="info-alert-content">
                    <div class="info-alert-title">Petunjuk Pengaturan</div>
                    <div class="info-alert-message">
                        <p>Selamat datang di halaman pengaturan kamera! Berikut beberapa tips untuk mengonfigurasi kamera Anda:</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">Tips Penggunaan:</h4>
                <ol style="padding-left: 20px; line-height: 1.5;">
                    <li>Untuk kamera webcam lokal, gunakan "0" sebagai URL</li>
                    <li>Untuk kamera IP, gunakan format URL RTSP (rtsp://username:password@ip-address:port/path)</li>
                    <li>Atur resolusi sesuai dengan kemampuan sistem Anda</li>
                    <li>Untuk performa terbaik, gunakan mode GPU jika tersedia</li>
                    <li>Pastikan area pintu dikonfigurasi dengan benar</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('info-modal')">Mengerti</button>
        </div>
    </div>
</div>

<!-- Processing mode confirmation modal -->
<div id="processing-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Konfirmasi Perubahan Mode Pemrosesan</h3>
            <button class="modal-close" onclick="closeModal('processing-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Anda akan mengubah mode pemrosesan ke <span id="selected-mode-text"></span>.</p>
            <p>Perubahan ini akan langsung diterapkan pada sistem dan mungkin memerlukan waktu beberapa detik.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-text" onclick="closeModal('processing-modal')">Batal</button>
            <button class="btn" id="confirm-processing-change">Konfirmasi</button>
        </div>
    </div>
</div>

<!-- Camera settings confirmation modal -->
<div id="camera-settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Konfirmasi Perubahan Pengaturan Kamera</h3>
            <button class="modal-close" onclick="closeModal('camera-settings-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-alert" style="margin-bottom: 16px;">
                <div class="info-alert-icon">‚ö†Ô∏è</div>
                <div class="info-alert-content">
                    <div class="info-alert-title">Perhatian</div>
                    <div class="info-alert-message">
                        Anda akan menyimpan perubahan pada pengaturan kamera. Perubahan ini mungkin akan me-restart koneksi kamera.
                    </div>
                </div>
            </div>
            
            <div id="settings-preview">
                <p><strong>Sumber Video:</strong> <span id="preview-source"></span></p>
                <p><strong>URL Kamera:</strong> <span id="preview-url"></span></p>
                <p><strong>Frame Rate:</strong> <span id="preview-framerate"></span></p>
                <p><strong>Resolusi:</strong> <span id="preview-resolution"></span></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-text" onclick="closeModal('camera-settings-modal')">Batal</button>
            <button class="btn" id="confirm-camera-settings">Konfirmasi</button>
        </div>
    </div>
</div>

<!-- Door configuration confirmation modal -->
<div id="door-config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Konfirmasi Konfigurasi Area Pintu</h3>
            <button class="modal-close" onclick="closeModal('door-config-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Anda akan menyimpan konfigurasi area pintu baru dengan koordinat:</p>
            <div style="margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: var(--radius-sm);">
                <p>X1: <span id="modal-x1"></span>, Y1: <span id="modal-y1"></span></p>
                <p>X2: <span id="modal-x2"></span>, Y2: <span id="modal-y2"></span></p>
                <p>Arah Dalam: <span id="modal-direction"></span></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-text" onclick="closeModal('door-config-modal')">Batal</button>
            <button class="btn" id="confirm-door-config">Konfirmasi</button>
        </div>
    </div>
</div>

<!-- Door configuration success modal -->
<div id="door-success-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Konfigurasi Berhasil Disimpan</h3>
            <button class="modal-close" onclick="closeModal('door-success-modal')">&times;</button>
        </div>        <div class="modal-body">
            <div class="alert alert-success" style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 24px;">‚úÖ</div>
                <div>
                    <p style="margin: 0; font-weight: 600;">Area pintu berhasil dikonfigurasi!</p>
                    <p style="margin: 5px 0 0 0;">Sistem akan menggunakan area ini untuk deteksi masuk/keluar.</p>
                </div>
            </div>
            
            <div id="door-success-details" style="margin-top: 16px; padding: 15px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <p style="margin: 0; color: var(--text-secondary);">Koordinat Atas Kiri:</p>
                        <p style="margin: 5px 0; font-weight: 600;"><span id="success-x1" class="success-highlight"></span>, <span id="success-y1" class="success-highlight"></span></p>
                    </div>
                    <div>
                        <p style="margin: 0; color: var(--text-secondary);">Koordinat Bawah Kanan:</p>
                        <p style="margin: 5px 0; font-weight: 600;"><span id="success-x2" class="success-highlight"></span>, <span id="success-y2" class="success-highlight"></span></p>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <p style="margin: 0; color: var(--text-secondary);">Arah Dalam Ruangan:</p>
                    <p style="margin: 5px 0; font-weight: 600;"><span id="success-direction" class="success-highlight"></span></p>
                </div>
                <div style="margin-top: 15px; background: var(--bg-tertiary); padding: 10px; border-radius: var(--radius-sm);">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <span style="color: var(--primary-color); font-weight: 600;">üí° Tip:</span> 
                        Ukuran area pintu: <span id="door-width" class="success-highlight"></span> √ó <span id="door-height" class="success-highlight"></span> piksel
                    </p>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem;">
                        Sistem penghitung orang akan mendeteksi pergerakan masuk/keluar di area ini.
                    </p>
                </div>
            </div>
        </div>        <div class="modal-footer">
            <button class="btn" onclick="closeModal('door-success-modal')" style="background: linear-gradient(135deg, var(--success-color), #065f46); color: white;">
                <span style="margin-right: 6px;">‚úì</span> Selesai
            </button>
        </div>
    </div>
</div>

<script>
    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'üí¨';
        if (type === 'success') icon = '‚úÖ';
        if (type === 'error') icon = '‚ùå';
        if (type === 'warning') icon = '‚ö†Ô∏è';
        
        toast.innerHTML = `
            <div class="toast-content">
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
        `;
        
        document.getElementById('toast-container').appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 4000);
    }

    // Function to show success modal after door area is saved
    function showSuccessDoorModal(data) {
        // Populate the success modal with door configuration data
        document.getElementById('success-x1').textContent = data.x1;
        document.getElementById('success-y1').textContent = data.y1;
        document.getElementById('success-x2').textContent = data.x2;
        document.getElementById('success-y2').textContent = data.y2;
        
        // Calculate door dimensions
        const doorWidth = Math.abs(data.x2 - data.x1);
        const doorHeight = Math.abs(data.y2 - data.y1);
        document.getElementById('door-width').textContent = doorWidth;
        document.getElementById('door-height').textContent = doorHeight;
        
        // Display direction in human-readable form
        let directionText = '';
        switch(data.inside_direction) {
            case 'right': directionText = '‚û°Ô∏è Sisi Kanan'; break;
            case 'left': directionText = '‚¨ÖÔ∏è Sisi Kiri'; break;
            case 'up': directionText = '‚¨ÜÔ∏è Sisi Atas'; break;
            case 'down': directionText = '‚¨áÔ∏è Sisi Bawah'; break;
            default: directionText = data.inside_direction;
        }
        document.getElementById('success-direction').textContent = directionText;
        
        // Show the success modal
        openModal('door-success-modal');
    }
</script>
{% endblock %}